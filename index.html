<!DOCTYPE html>
<html>
  <head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <title>Governmental Health Spending Slideshow</title>
  </head>

  <body>
    <h1>How Does Governmental Health Expenditure Improve Citizen Lifespan & Health?</h1>

    <p>
      Governments spend millions, billions, and even trillions of dollars to the improve the lives of their citizens. Much of the spending is 
      on research and development projects or defense contracts. While important issues it is unclear how important these topics are
      to the health and wellbeing of the public. This narrative visualization slideshow highlights the importance of governmental health spending
      to improve health related metrics including infant mortality, obesity rate, and life expectancy.
    </p>
    
    <div id="btns">
      <button id="prev">Prev</button>
      <button class="scene" data-scene="0">1</button>
      <button class="scene" data-scene="1">2</button>
      <button class="scene" data-scene="2">3</button>
      <button id="next">Next</button>
    </div>

    <svg id="chart" width="900" height="600"></svg>

    <script>
      const metrics = [
        { key: "infantMort", label: "Infant mortality (per 1,000 births)", invert: true },
        { key: "obesityPct", label: "Adult obesity (%)", invert: false },
        { key: "lifeExp",    label: "Life expectancy (years)", invert: false }
      ];

      const data_url = "WDI Narrative Vizualization Full Stats.csv";

      const svg = d3.select('#chart');
      const W = +svg.attr("width");
      const H = +svg.attr("height");
      const M = {top: 20, right: 20, bottom: 55, left: 80};
      const borderW = W - M.left - M.right;
      const borderH = H - M.top - M.bottom;
      const iw = borderW, ih = borderH;

      const x = d3.scaleLog().range([0, borderW]);
      const y = d3.scaleLinear().range([borderH, 0]);
      
      const g  = svg.append("g").attr("transform", `translate(${M.left}, ${M.top})`);
      const gx = g.append("g").attr("transform", `translate(0, ${borderH})`);
      const gy = g.append("g");
      const dotsG = g.append("g");
      const legendG = svg.append("g").attr("transform", `translate(${W - M.right - 160}, ${M.top})`);

      const xLabel = g.append("text")
        .attr("x", iw/2).attr("y", ih + 40).attr("text-anchor", "middle")
        .text("Health expenditure per capita (US$)");
      const yLabel = g.append("text")
        .attr("transform", "rotate(-90)").attr("x", -ih/2).attr("y", -55).attr("text-anchor", "middle");
      
      let color = null;
      let scene = 0;
      let data = [];
      let regions = [];

      const COL = {
        year: "Time",
        country: "Country Name",
        code: "Country Code",
        region: "Region",
        xval: "Current health expenditure per capita (current US$) [SH.XPD.CHEX.PC.CD]",
        life: "Life expectancy at birth, total (years) [SP.DYN.LE00.IN]",
        infant: "Mortality rate, infant (per 1,000 live births) [SP.DYN.IMRT.IN]",
        obesity: "Male & Female Obesity Rate"
      };
      
      d3.csv(data_url, d3.autoType).then(rows => {
        data = rows
          .filter(d => +d[COL.year] === 2016)
          .map(d => ({
            country: d[COL.country],
            code: d[COL.code],
            region: d[COL.region],
            year: +d[COL.year],
            healthExpPC: +d[COL.xval],
            lifeExp: +d[COL.life],
            infantMort: +d[COL.infant],
            obesityPct: +d[COL.obesity]
          }))
          .filter(d => d.region && d.healthExpPC > 0 && [d.lifeExp, d.infantMort, d.obesityPct].every(Number.isFinite));

        x.domain(d3.extent(data, d => d.healthExpPC));
        regions = Array.from(new Set(data.map(d => d.region))).sort();
        color = d3.scaleOrdinal(regions, d3.schemeCategory10);

        gx.call(d3.axisBottom(x).ticks(6).tickFormat(d => "$" + d3.format("~s")(d)));

        drawLegend();
        drawScene(true);
        setupNavigation();
      });

      function drawLegend(){
        const row = legendG.selectAll("g").data(regions, d => d);
        const enter = row.enter().append("g").attr("transform", (d,i) => `translate(0, ${i*18})`);
        enter.append("rect").attr("width", 12).attr("height", 12).attr("rx", 2).attr("ry", 2).attr("fill", d => color(d));
        enter.append("text").attr("x", 18).attr("y", 10).attr("font-size", 12).text(d => d);
        row.exit().remove();
      }

      function tooltipText(d){
        return (
          d.country + "\n" +
          "Region: " + d.region + "\n" +
          "Health exp per cap: $" + d3.format(",.0f")(d.healthExpPC) + "\n" +
          "Life expectancy: " + d3.format(".1f")(d.lifeExp) + " yrs\n" +
          "Obesity: " + d3.format(".1f")(d.obesityPct) + " %\n" +
          "Infant mortality: " + d3.format(".1f")(d.infantMort) + " / 1,000"
        );
      }

      function drawScene(initial=false){
        const def = metrics[scene];
        const extent = d3.extent(data, d => d[def.key]);
        y.domain(def.invert ? [extent[1], extent[0]] : extent);

        gy.transition().duration(initial?0:700).call(d3.axisLeft(y).ticks(8));
        yLabel.text(def.label);

        const sel = dotsG.selectAll("circle").data(data, d => d.code);

        const entered = sel.enter().append("circle")
          .attr("r", 4)
          .attr("cx", d => x(d.healthExpPC))
          .attr("cy", d => y(d[def.key]))
          .attr("fill", d=> color(d.region))
          .attr("opacity", 0.9);

        entered.append("title").text(d => tooltipText(d));

        sel.transition().duration(initial?0:700).ease(d3.easeCubicInOut)
          .attr("cx", d => x(d.healthExpPC))
          .attr("cy", d => y(d[def.key]));

        sel.select("title").text(d => tooltipText(d));

        sel.exit().remove();
        setButtons();
      }

      function gotoScene(s){
        const target = Math.max(0, Math.min(2, s));
        if (target !== scene){ scene = target; drawScene(); }
      }

      function setButtons(){
        document.getElementById("prev").disabled = (scene === 0);
        document.getElementById("next").disabled = (scene === 2);
      }

      function setupNavigation() {
        document.getElementById("prev").addEventListener("click", () => gotoScene(scene-1));
        document.getElementById("next").addEventListener("click", () => gotoScene(scene+1));
        document.querySelectorAll(".scene").forEach(b => b.addEventListener("click", e => gotoScene(+e.currentTarget.dataset.scene)));
        setButtons();
      }
    </script>
  </body>
</html>
