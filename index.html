<!DOCTYPE html>
<html>
  <head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
    <title>CS416 Narrative Visualization: Health Spending Slideshow</title>
  </head>

  <body>
    <h1>How Does Governmental Health Expenditure Improve Quality of Life?</h1>

    <p>
      Governments spend millions, billions, and even trillions of dollars to the improve the lives of their citizens. Much of the spending is 
      on research and development projects or defense contracts. While important issues it is unclear how important these topics are
      to the health and wellbeing of the public. This narrative visualization slideshow highlights the importance of governmental health spending
      to improve health related metrics including infant mortality, obesity rate, and life expectancy.
    </p>
    
    <div id="btns">
      <button id="prev">Prev</button>
      <button class="scene" data-scene="0">1</button>
      <button class="scene" data-scene="1">2</button>
      <button class="scene" data-scene="2">3</button>
      <button id="next">Next</button>
    </div>

    <svg id="chart" width="900" height="600"></svg>

    <script>
      const metrics = [
        { key: "infantMort", label: "Infant mortality (per 1,000 births)", invert: false },
        { key: "obesityPct", label: "Adult obesity (%)", invert: false },
        { key: "lifeExp",    label: "Life expectancy (years)", invert: false }
      ];
      const slideNotes = ["Slide 1 annotation","Slide 2 annotation","Slide 3 annotation"];

      const data_url = "WDI Narrative Vizualization Full Stats.csv";

      const svg = d3.select('#chart');
      const W = +svg.attr("width");
      const H = +svg.attr("height");
      const RIGHT = 220;
      const M = {top: 20, right: 20, bottom: 55, left: 80};
      const borderW = W - M.left - M.right - RIGHT;
      const borderH = H - M.top - M.bottom;
      const iw = borderW, ih = borderH;

      const x = d3.scaleLog().range([0, borderW]);
      const y = d3.scaleLinear().range([borderH, 0]);
      
      const g  = svg.append("g").attr("transform", `translate(${M.left}, ${M.top})`);
      const gx = g.append("g").attr("transform", `translate(0, ${borderH})`);
      const gy = g.append("g");
      const dotsG = g.append("g");
      const annG  = g.append("g");

      const sidebarX = M.left + borderW + 24;
      const legendG = svg.append("g").attr("transform", `translate(${sidebarX}, ${M.top})`);
      const noteG   = svg.append("g").attr("transform", `translate(${sidebarX}, ${M.top + 20 + 18*8})`);

      const xLabel = g.append("text").attr("x", iw/2).attr("y", ih + 40).attr("text-anchor", "middle").text("Health expenditure per capita (US$)");
      const yLabel = g.append("text").attr("transform", "rotate(-90)").attr("x", -ih/2).attr("y", -55).attr("text-anchor", "middle");
      
      let color = null;
      let scene = 0;
      let data = [];
      let regions = [];

      const COL = {
        year: "Time",
        country: "Country Name",
        code: "Country Code",
        region: "Region",
        xval: "Current health expenditure per capita (current US$) [SH.XPD.CHEX.PC.CD]",
        life: "Life expectancy at birth, total (years) [SP.DYN.LE00.IN]",
        infant: "Mortality rate, infant (per 1,000 live births) [SP.DYN.IMRT.IN]",
        obesity: "Male & Female Obesity Rate"
      };
      
      d3.csv(data_url, d3.autoType).then(rows => {
        data = rows
          .filter(d => +d[COL.year] === 2016)
          .map(d => ({
            country: d[COL.country],
            code: d[COL.code],
            region: d[COL.region],
            year: +d[COL.year],
            healthExpPC: +d[COL.xval],
            lifeExp: +d[COL.life],
            infantMort: +d[COL.infant],
            obesityPct: +d[COL.obesity]
          }))
          .filter(d => d.region && d.healthExpPC > 0 && [d.lifeExp, d.infantMort, d.obesityPct].every(Number.isFinite));

        const xExtent = d3.extent(data, d => d.healthExpPC);
        const minX = xExtent[0], maxX = xExtent[1];
        const lowerPad = Math.pow(10, Math.floor(Math.log10(minX)));
        x.domain([Math.min(10, lowerPad), maxX]).nice();

        regions = Array.from(new Set(data.map(d => d.region))).sort();
        color = d3.scaleOrdinal(regions, d3.schemeCategory10);

        gx.call(d3.axisBottom(x).ticks(6).tickFormat(d => "$" + d3.format("~s")(d)));

        drawLegend();
        initNote();
        drawScene(true);
        setupNavigation();
      });

      function drawLegend(){
        legendG.selectAll("*").remove();
        legendG.append("text").attr("x",0).attr("y",0).text("Region").attr("font-size",12).attr("font-weight","bold");
        const row = legendG.selectAll("g.row").data(regions, d => d).enter()
          .append("g").attr("class","row").attr("transform", (d,i) => `translate(0, ${20 + i*18})`);
        row.append("rect").attr("width",12).attr("height",12).attr("fill", d => color(d));
        row.append("text").attr("x",18).attr("y",10).attr("font-size",12).text(d => d);
      }

      function initNote(){
        noteG.selectAll("*").remove();
        noteG.append("text").attr("x",0).attr("y",0).text("Slide notes").attr("font-size",12).attr("font-weight","bold");
        noteG.append("text").attr("id","note-text").attr("x",0).attr("y",18).attr("font-size",12).text(slideNotes[scene]);
      }

      function updateNote(){
        d3.select("#note-text").text(slideNotes[scene]);
      }

      function tooltipText(d){
        return (
          d.country + "\n" +
          "Region: " + d.region + "\n" +
          "Health exp per cap: $" + d3.format(",.0f")(d.healthExpPC) + "\n" +
          "Life expectancy: " + d3.format(".1f")(d.lifeExp) + " yrs\n" +
          "Obesity: " + d3.format(".1f")(d.obesityPct) + " %\n" +
          "Infant mortality: " + d3.format(".1f")(d.infantMort) + " / 1,000"
        );
      }

      function drawScene(initial=false){
        const def = metrics[scene];
        const extent = d3.extent(data, d => d[def.key]);
        y.domain([extent[0], extent[1]]);
        gy.transition().duration(initial?0:700).call(d3.axisLeft(y).ticks(8));
        yLabel.text(def.label);

        const sel = dotsG.selectAll("circle").data(data, d => d.code);

        const entered = sel.enter().append("circle")
          .attr("r", 4)
          .attr("cx", d => x(d.healthExpPC))
          .attr("cy", d => y(d[def.key]))
          .attr("fill", d=> color(d.region))
          .attr("opacity", 0.9);
        entered.append("title").text(d => tooltipText(d));

        sel.transition().duration(initial?0:700).ease(d3.easeCubicInOut)
          .attr("cx", d => x(d.healthExpPC))
          .attr("cy", d => y(d[def.key]));
        sel.select("title").text(d => tooltipText(d));

        sel.exit().remove();

        drawThreeExampleAnnotations();
        updateNote();
        setButtons();
      }

      function drawThreeExampleAnnotations(){
        annG.selectAll("*").remove();
        const annotations = [
          { type: d3.annotationCalloutCircle, note: { label: "Circle 1" }, x: 140, y: 140, dx: 60,  dy: -40, subject: { radius: 32, radiusPadding: 6 } },
          { type: d3.annotationCalloutCircle, note: { label: "Circle 2" }, x: 360, y: 300, dx: -80, dy: -50, subject: { radius: 28, radiusPadding: 6 } },
          { type: d3.annotationCalloutCircle, note: { label: "Circle 3" }, x: 600, y: 200, dx: -70, dy: 60,  subject: { radius: 35, radiusPadding: 6 } }
        ];
        const make = d3.annotation().type(d3.annotationCalloutCircle).annotations(annotations);
        annG.call(make);
      }

      function gotoScene(s){
        const target = Math.max(0, Math.min(2, s));
        if (target !== scene){ scene = target; drawScene(); }
      }

      function setButtons(){
        document.getElementById("prev").disabled = (scene === 0);
        document.getElementById("next").disabled = (scene === 2);
      }

      function setupNavigation() {
        document.getElementById("prev").addEventListener("click", () => gotoScene(scene-1));
        document.getElementById("next").addEventListener("click", () => gotoScene(scene+1));
        document.querySelectorAll(".scene").forEach(b => b.addEventListener("click", e => gotoScene(+e.currentTarget.dataset.scene)));
        setButtons();
      }
    </script>
  </body>
</html>
